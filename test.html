
<!DOCTYPE html>
<meta charset="utf-8">
<style>
body{
  background: #333;
  margin: 0;

}
#cbsa-borders{
  color: #333;
}
  #map, #chart {
    /*margin:2%;*/
    width: 96%;
    margin: 0;
    padding:2%;
    /*border:2px solid #d0d0d0;*/
    border-radius: 5px;
    /*display: inline-block;*/
  }
  .county-boundary{
    fill: black;
  }

rect.LL{
  fill: #ec008b;
}
rect.SL{
  fill: #eb99c2;
}
rect.NC{
  fill: #e2e2e2;
}
rect.SI{
  fill: #a2d4ec;
}
rect.LI{
  fill: #1696d2;
}
rect.highlight_rect{
  fill: none;
  stroke-width: 2px;
  stroke: #ec008b;
}
</style>
<body>
<!-- <div id ="map"></div> -->
<select id = "topics_selector">
  <option value = "all_topics">All topics</option>
	<option value = "arts">1 Arts</option>
	<option value = "higher_ed">2a Higher Education</option>
	<option value = "other_ed">2b Other Education</option>
	<option value = "environment">3 Environment and Animals</option>
	<option value = "hospitals">4a Hospitals</option>
	<option value = "other_health">4b Other Health</option>
	<option value = "human_services">5 Human Services</option>
	<option value = "international">6 International and Foreign Affairs</option>
	<option value = "religion">7 Religion Related</option>
	<option value = "other">8 Other</option>
</select>

<select id = "state_selector">
  <option value = "all_states">All states</option>
  <option value = "fips_02">AK</option>
  <option value = "fips_01">AL</option>
  <option value = "fips_05">AR</option>
  <option value = "fips_04">AZ</option>
  <option value = "fips_06">CA</option>
  <option value = "fips_08">CO</option>
  <option value = "fips_09">CT</option>
  <option value = "fips_11">DC</option>
  <option value = "fips_10">DE</option>
  <option value = "fips_12">FL</option>
  <option value = "fips_13">GA</option>
  <option value = "fips_15">HI</option>
  <option value = "fips_19">IA</option>
  <option value = "fips_16">ID</option>
  <option value = "fips_17">IL</option>
  <option value = "fips_18">IN</option>
  <option value = "fips_20">KS</option>
  <option value = "fips_21">KY</option>
  <option value = "fips_22">LA</option>
  <option value = "fips_25">MA</option>
  <option value = "fips_24">MD</option>
  <option value = "fips_23">ME</option>
  <option value = "fips_26">MI</option>
  <option value = "fips_27">MN</option>
  <option value = "fips_29">MO</option>
  <option value = "fips_28">MS</option>
  <option value = "fips_30">MT</option>
  <option value = "fips_37">NC</option>
  <option value = "fips_38">ND</option>
  <option value = "fips_31">NE</option>
  <option value = "fips_33">NH</option>
  <option value = "fips_34">NJ</option>
  <option value = "fips_35">NM</option>
  <option value = "fips_32">NV</option>
  <option value = "fips_36">NY</option>
  <option value = "fips_39">OH</option>
  <option value = "fips_40">OK</option>
  <option value = "fips_41">OR</option>
  <option value = "fips_42">PA</option>
  <option value = "fips_44">RI</option>
  <option value = "fips_45">SC</option>
  <option value = "fips_46">SD</option>
  <option value = "fips_47">TN</option>
  <option value = "fips_48">TX</option>
  <option value = "fips_49">UT</option>
  <option value = "fips_51">VA</option>
  <option value = "fips_50">VT</option>
  <option value = "fips_53">WA</option>
  <option value = "fips_55">WI</option>
  <option value = "fips_54">WV</option>
  <option value = "fips_56">WY</option>
</select>


<div id ="chart"></div>




<script src="//d3js.org/d3.v4.0.0-rc.2.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
<script>

var TOPICS = {
  "1 Arts" : "arts",
  "2a Higher Education" : "higher_ed",
  "2b Other Education" : "other_ed",
  "3 Environment and Animals" : "environment",
  "4a Hospitals" : "hospitals",
  "4b Other Health" : "other_health",
  "5 Human Services" : "human_services",
  "6 International and Foreign Affairs" : "international",
  "7 Religion Related" : "religion",
  "8 Other" : "other",
  "none" : "none"
}
var FIPS = {"AK":"02", "AL":"01", "AR":"05", "AZ":"04", "CA":"06", "CO":"08", "CT":"09", "DC":"11", "DE":"10", "FL":"12", "GA":"13", "HI":"15", "IA":"19", "ID":"16", "IL":"17", "IN":"18", "KS":"20", "KY":"21", "LA":"22", "MA":"25", "MD":"24", "ME":"23", "MI":"26", "MN":"27", "MO":"29", "MS":"28", "MT":"30", "NC":"37", "ND":"38", "NE":"31", "NH":"33", "NJ":"34", "NM":"35", "NV":"32", "NY":"36", "OH":"39", "OK":"40", "OR":"41", "PA":"42", "RI":"44", "SC":"45", "SD":"46", "TN":"47", "TX":"48", "UT":"49", "VA":"51", "VT":"50", "WA":"53", "WI":"55", "WV":"54", "WY":"56"}


// d3.select("body").on("click", function(){

// d3.selectAll(".small_chart").transition()
// .duration(1000)
// .attr("transform","scale(100,100)")
// })

var color = d3.scaleThreshold()
    .domain([-80, -60, -40, -20, 0, 20, 40, 60, 80])
    .range(["rgb(255, 79, 0)", "rgb(255, 132, 0)", "rgb(253, 185, 19)", "rgb(255, 217, 144)", "rgb(255, 235, 196)", "rgb(207, 227, 245)","rgb(130, 196, 233)","rgb(22, 150, 210)","rgb(0, 118, 188)","rgb(29, 66, 129)"]);
  d3.select(window)
        .on("load", sizeChange)
        .on("resize", sizeChange);

  var projection = d3.geoAlbersUsa()
    .scale(1100);

  var path = d3.geoPath()
    .projection(projection);
    // console.log(path)

  var svg = d3.select("#map")
    .append("svg")
    .attr("width", "100%")
        .append("g");
  
//   d3.json("data/data.json", function(error, us) {
//     if (error) throw error;
//    //  svg.selectAll(".states")
//    //  // .data(topojson.object(us, us.objects.cb_2015_us_cbsa_500k).geometries)
//    //  // .data(topojson.mesh(us, us.objects.cb_2015_us_cbsa_500k, function(a, b) { console.log(a !== b && !(a.properties.GEOID != b.properties.GEOID)); return a !== b && !(a.properties.GEOID != b.properties.GEOID); }))
//    //  .data(topojson.feature(us, us.objects.cb_2015_us_cbsa_500k))

//    // .enter().append("path")
//    //  .attr("class", "states")
//    //  .style("stroke","black")
//    //  .attr("d", path);



// // console.log(topojson.feature(us, us.objects.cb_2015_us_cbsa_500k).features)
// var filtered = topojson.feature(us, us.objects.cb_2015_us_cbsa_500k).features.filter(function(d){
//   return d.properties.hasOwnProperty("growth")
//   // console.log(d)

// })
//   svg.selectAll("path")
//       .data(filtered)
//       .attr("class", "county-boundary")
//       // .attr("d", path)
//       .enter().append("path")
//       .attr("d",path)

//       .style("fill",function(d,i){ return color(+d.properties.growth);})
//       .style("stroke","#fff")
//       .on("mouseover", function(d,i){console.log(d)})



//   });


var chart = d3.select("#chart")
    .append("svg")
    .attr("width", "100%")
    .append("g");

d3.csv("data/test.csv", function(err, data){
  // console.log(data)
  var data = data.filter(function(d){
  return d.hasOwnProperty("growth") && d["growth"] != "NULL"
  // console.log(d)
  
  })
  .sort(function(a, b) {
          if(parseFloat(a["GRREC % NC"]) == 100 || parseFloat(b["GRREC % NC"]) == 100) return Infinity

else      return ( parseFloat(a["GRREC % LI"]) + parseFloat(a["GRREC % SI"]) ) - ( parseFloat(b["GRREC % SI"]) + parseFloat(b["GRREC % LI"]) )
  });
  // .sort(function(a, b) {
  //     if(parseFloat(a["GRREC % NC"]) == 100) return Infinity
  //     else if( (parseFloat(b["GRREC % LL"])+parseFloat(b["GRREC % SL"])) > (parseFloat(b["GRREC % LI"])+parseFloat(b["GRREC % SI"]))){
  //       return parseFloat(a["GRREC % LL"]) - parseFloat(b["GRREC % LL"])
  //     }
  //     else if((parseFloat(b["GRREC % LI"])+parseFloat(b["GRREC % SI"])) == (parseFloat(a["GRREC % LI"]) + parseFloat(a["GRREC % SI"]))){
  //       return parseFloat(b["GRREC % LI"]) - parseFloat(a["GRREC % LI"])
  //     }else{
  //         return (parseFloat(b["GRREC % LI"])+parseFloat(b["GRREC % SI"])) - (parseFloat(a["GRREC % LI"]) + parseFloat(a["GRREC % SI"]))
  //     }
  //   // };
  //   // return parseFloat(b["growth"]) - parseFloat(a["growth"])
  // });
  console.log(data)
  var margin = {"left":10,"top":10,"right":10,"bottom":10}
  var rowCount,
    small_width = 7,
    gutter = 0;
  rowCount = Math.floor((d3.select("#chart svg").node().getBoundingClientRect().width - margin.left - margin.right) / (small_width + gutter))
  var small_chart = chart.selectAll(".small_chart")
    .data(data)
    .enter()
    .append("g")
    .attr("class",function(d){
      var state;
      if(d["CBSA Name"].search(",") != -1){
        state = d["CBSA Name"].split(", ")[1]
      }else{
        state = d["CBSA Name"]
      }
      // console.log(state)
      states = state.split("-")
      var fips = " ";
      for(var i = 0; i < states.length; i++){
        fips += "fips_" + String(FIPS[states[i]]) + " "
      }
      console.log(fips)
      return "small_chart " + TOPICS[d["NTEEGROUP"]] + " cbsa_" + d["CBSA"] + fips
    })
    .attr("width",small_width + "px")
    .attr("height",small_width + "px")
    .attr("transform", function(d,i){
      i += 1;
      var x = margin.left + ( (((i-1)%rowCount)) * (small_width+gutter) )
      var y = margin.top + ( (Math.ceil(i/rowCount)-1) * (small_width+gutter) )
      return "translate(" + x + "," + y + ")"
    })
    .on("mouseover", function(d){
      d3.selectAll(".small_chart").style("opacity",1)
      d3.selectAll(".small_chart:not(." + TOPICS[d["NTEEGROUP"]] + ")")
        .style("opacity",.2)
    })
    // .on("mouseout", function(d){
    //   d3.selectAll(".small_chart").style("opacity",1)
    // })
  var cats = ["GRREC % LI","GRREC % SI","GRREC % NC","GRREC % SL","GRREC % LL"]
  var start = 0;
  for(var i = 0; i < cats.length; i++){
    var cat = cats[i]
    console.log(i)
    small_chart
      .append("rect")
      .attr("width", function(d){ return small_width*(parseFloat(d[cat])/100)})
      .attr("x", function(d){
        if(isNaN(d[cat])){
          console.log(d)
        }
        var start = 0;
        for(var j =0; j < i ; j++){
          start += small_width*parseFloat(d[cats[j]])/100
        }
        return start;
      })
      .attr("height", small_width)
      .attr("y",0)
      .attr("class",cat.split(" % ")[1])
      // .attr("fill", function(d){ return color(d["growth"])})

      // start += small_width*parseFloat(small_chart.datum()[cat])/100
    
  }
d3.select("#topics_selector")
  .on("change", function(){
    // console.log(this.value)
    d3.selectAll(".small_chart")
      .style("opacity",1)
    d3.selectAll(".small_chart:not(." + this.value + ")")
      // .append("rect")
      // .attr("x",-1)
      // .attr("y",-1)
      // .attr("width",small_width + 2)
      // .attr("height",small_width + 2)
      // .attr("class","highlight_rect")
      // .transition()
      .style("opacity",".2")
  })

d3.select("#state_selector")
  .on("change", function(){
    // console.log(this.value)
    d3.selectAll(".small_chart")
      .style("opacity",1)
    d3.selectAll(".small_chart:not(." + this.value + ")")
      // .append("rect")
      // .attr("x",-1)
      // .attr("y",-1)
      // .attr("width",small_width + 2)
      // .attr("height",small_width + 2)
      // .attr("class","highlight_rect")
      // .transition()
      .style("opacity",".2")
  })
  // small_chart.append("text").text(function(d,i){ return i})

    // .attr("y", function(d,i){
    //   i += 1;
    //   return ( (Math.ceil(i/rowCount)) * (small_width+gutter) ) + "px"
    // })
    // .attr("fill",function(d){ console.log(d); return color(+d.growth) } )
})

  function sizeChange() {
      d3.select("#map svg g").attr("transform", "scale(" + $("#map").width()/900 + ")");
      d3.select("#chart svg g").attr("transform", "scale(" + $("#chart").width()/900 + ")");
      d3.select("g").attr("transform", "scale(" + $("#chart").width()/900 + ")");

      $("#map svg").height($("#map").width()*0.618);
      $("#chart svg").height($("#chart").width()*10);

  }


 // var map;

 //  function Map(topology) {
 //    console.log(topology)

 //    // Convert the topojson to geojson
 //    var geojson = topojson.feature(topology, topology.objects.cb_2015_us_cbsa_500k),
 //   projection = d3.geo.albersUsa()
 //    .scale(1100);

 //    // Since we're using projected TopoJSON, we use a null projection here.
 //        path = d3.geo.path().projection(projection),

 //    // Use topojson.mesh to create a path representing county outlines.
 //        countyMesh = topojson.mesh(topology, topology.objects.cb_2015_us_cbsa_500k, function(a, b) {
 //          return a.properties.GEOID !== b.properties.GEOID;
 //        }),

 //        svg = d3.select("#map").append("svg")
 //                    .attr({
 //                      width: 615,
 //                      height: 375
 //                    }),

 //        g = svg.append("g").attr({"class": "g-town"}),

 //        colorScale = d3.scale.category20b(),

 //        // Add town paths
 //        town = g.selectAll("path.town").data(geojson.features)
 //                  .enter().append("path")
 //                    .attr({
 //                      "class": "town",
 //                      d: path
 //                    })
 //                    .style({
 //                      fill: "grey",
 //                      stroke: "black"
 //                    }),

 //        // Add county path and set its opacity to 0,
 //        // since we don't want to show it initially.
 //        county = g.append("path").datum(countyMesh)
 //                  .attr({
 //                    "class": "county",
 //                    d: path
 //                  })
 //                  .style({
 //                    opacity: 0,
 //                    stroke: "white",
 //                    "stroke-width": 2,
 //                    fill: "none"
 //                  }),

 //        currentState = "town";

 //        // To show the county outlines, we
 //        // transition the town shapes to have
 //        // a consistent stroke, and fill, in effect hiding
 //        // them. We also transition the county
 //        // path to be visible.
 //        this.showCounties = function() {
 //          var countyColors = {};

 //          // Since we're using a mesh for the county outlines,
 //          // it doesn't work well to add the fill to the county
 //          // path. Instead, we'll set a consistent fill on all 
 //          // the towns in each county, to give the effect of 
 //          // filling in the county.
 //          town.transition()
 //            .duration(600)
 //            .style({
 //              fill: function(d, i) {
 //                if (!countyColors[d.properties.GEOID]) {
 //                  countyColors[d.properties.GEOID] = colorScale(Math.floor(Math.random()*1000));
 //                }
 //                return countyColors[d.properties.GEOID];
 //              },
 //              stroke: function(d, i) {
 //                return "black"
 //              }
 //            });

 //          county.transition()
 //            .duration(600)
 //            .style({
 //              opacity: 1
 //            })
 //        };

 //        // To show the town outlines, we transition
 //        // back to our original state.
 //        this.showTowns = function() {
 //          town.transition()
 //            .duration(600)
 //            .style({
 //              stroke: "white",
 //              fill: function(d, i) {
 //                return colorScale(Math.floor(Math.random()*1000));
 //              }
 //            });

 //          county.transition()
 //            .duration(600)
 //            .style({
 //              opacity: 0
 //            })
 //        };

 //        this.toggle = function() {
 //          if (currentState === "town") {
 //            this.showCounties();
 //            currentState = "county";
 //          } else {
 //            this.showTowns();
 //            currentState = "town";
 //          }
 //        };
 //  }

 //  d3.json("data/data.json", function(err, topology) {
 //    map = new Map(topology);
 //  });

 //  d3.select("#toggle").on("click", function() {
 //    map.toggle();
 //  });


</script>
